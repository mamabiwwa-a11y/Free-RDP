name: Linux_GUI_RDP

on:
  workflow_dispatch:

jobs:
  linux-gui:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Update and Install Desktop Environment (XFCE) & XRDP
        run: |
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies xrdp
          # Fix for dbus error
          sudo apt-get install -y dbus-x11
          sudo service xrdp start

      - name: Configure XRDP to use XFCE (Global)
        run: |
          sudo sed -i.bak '/fi/a #xrdp multiple users configuration \n xfce4-session \n' /etc/xrdp/startwm.sh

      - name: Create User for RDP with Session Fix
        run: |
          # Create user
          sudo useradd -m -s /bin/bash runneradmin
          echo "runneradmin:password123" | sudo chpasswd
          sudo usermod -aG sudo runneradmin
          
          # This is the FIX for 'failsafe session' error:
          # We force the .xsession file into the user's home directory
          sudo bash -c 'echo "xfce4-session" > /home/runneradmin/.xsession'
          sudo chown runneradmin:runneradmin /home/runneradmin/.xsession
          
          echo "=========================================="
          echo "Username: runneradmin"
          echo "Password: password123"
          echo "=========================================="

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          sudo tailscale up --authkey=$TAILSCALE_AUTH_KEY --hostname=linux-desktop-box
          
      - name: Display IP Address
        run: |
          echo "=========================================="
          echo "Tailscale IP:"
          tailscale ip -4
          echo "=========================================="

      - name: Keep Alive Loop
        run: |
          while true; do
            sleep 300
          done
