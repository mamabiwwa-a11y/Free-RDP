name: Setup Temporary Linux VPS with RDP

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies xrdp xorg dbus-x11 x11-xserver-utils xfce4-session tailscale

      - name: Create and Configure User
        run: |
          sudo useradd -m -s /bin/bash runneradmin
          echo 'runneradmin:securepassword' | sudo chpasswd  # Change password
          sudo usermod -aG sudo,ssl-cert runneradmin

      - name: Configure XRDP and D-Bus Session
        run: |
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          sudo -u runneradmin bash -c 'echo "#!/bin/sh\nunset DBUS_SESSION_BUS_ADDRESS\nunset SESSION_MANAGER\ndbus-launch xfce4-session" > ~/.xsession'
          sudo chmod 755 /home/runneradmin/.xsession
          # Fallback: Modify startwm.sh for global D-Bus
          sudo sed -i.bak '/test -x/i \nexport $(dbus-launch)\n' /etc/xrdp/startwm.sh
          sudo systemctl restart xrdp

      - name: Setup Tailscale VPN Tunnel
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --advertise-routes=10.0.0.0/24  # Use your auth key
          tailscale ip -4  # Output for connection

      - name: Keep Workflow Alive (Optional for Testing)
        run: sleep 36000  # 10 hours; adjust as needed
