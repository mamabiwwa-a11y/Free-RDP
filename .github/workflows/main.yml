
name: Linux_GUI_RDP

on:
  workflow_dispatch:

jobs:
  linux-gui:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Update and Install Desktop Environment
        run: |
          sudo apt-get update
          # Install XFCE, XRDP, and XORG (Important!)
          sudo apt-get install -y xfce4 xfce4-goodies xrdp xorg dbus-x11 x11-xserver-utils
          sudo systemctl enable xrdp
          sudo service xrdp start

      - name: Hard Force XFCE Startup (The Nuclear Fix)
        run: |
          # Backup original startwm.sh
          sudo mv /etc/xrdp/startwm.sh /etc/xrdp/startwm.sh.bak
          
          # Create a fresh startwm.sh that ONLY starts XFCE
          sudo bash -c "cat > /etc/xrdp/startwm.sh <<EOF
          #!/bin/sh
          if [ -r /etc/default/locale ]; then
            . /etc/default/locale
            export LANG LANGUAGE
          fi
          startxfce4
          EOF"
          
          # Make it executable
          sudo chmod +x /etc/xrdp/startwm.sh
          sudo service xrdp restart

      - name: Create User
        run: |
          sudo useradd -m -s /bin/bash runneradmin
          echo "runneradmin:password123" | sudo chpasswd
          sudo usermod -aG sudo runneradmin
          
          # Force .xsession for the user as well
          sudo bash -c 'echo "xfce4-session" > /home/runneradmin/.xsession'
          sudo chown runneradmin:runneradmin /home/runneradmin/.xsession
          
          echo "=========================================="
          echo "Username: runneradmin"
          echo "Password: password123"
          echo "=========================================="

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          sudo tailscale up --authkey=$TAILSCALE_AUTH_KEY --hostname=linux-desktop-final
          
      - name: Display IP Address
        run: |
          echo "=========================================="
          echo "Tailscale IP:"
          tailscale ip -4
          echo "=========================================="

      - name: Keep Alive Loop
        run: |
          while true; do
            sleep 300
          done
